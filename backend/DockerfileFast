# -----------------------------------------------------
# FASE 1: BASE E INSTALACIÓN DE DEPENDENCIAS
# -----------------------------------------------------
# Usamos una imagen oficial de Python 3.11 Slim (más pequeña)
FROM python:3.11-slim

# Establece el directorio de trabajo dentro del contenedor
WORKDIR /app

# -----------------------------------------------------
# INSTALACIÓN DE DEPENDENCIAS DE SISTEMA PARA PLAYWRIGHT/CHROMIUM
# -----------------------------------------------------

# Estas librerías son necesarias para que el navegador se ejecute en un entorno Linux headless
# RUN apt-get update && apt-get install -y \
#     # Dependencias comunes de Playwright (incluye GLib)
#     libnss3 \
#     libxcomposite1 \
#     libxrandr2 \
#     libgbm-dev \
#     libasound2 \
#     libatk-bridge2.0-0 \
#     libgtk-3-0 \
#     # libglib-2.0.so.0 suele estar incluida en estas dependencias o en los paquetes base.
#     # Si persiste el error de libglib-2.0.so.0, asegúrate de que 'libglib2.0-0' esté incluida
#     libglib2.0-0 \
#     --no-install-recommends \
#     && rm -rf /var/lib/apt/lists/*

# Copia solo el archivo requirements.txt primero. 
# Esto aprovecha el caching de Docker. Si las dependencias no cambian,
# esta fase no se vuelve a ejecutar.
COPY requirements2.txt .

# Instala las dependencias de Python
# El flag --no-cache-dir reduce el tamaño final de la imagen
RUN pip install --no-cache-dir -r requirements2.txt

# Si has incluido 'playwright' en requirements.txt, necesitas instalar sus navegadores:
# Si NO usas playwright, puedes omitir estas 3 líneas.
# RUN if grep -q "playwright" requirements.txt; then \
#     pip install playwright; \
#     playwright install; \
# fi

# -----------------------------------------------------
# FASE 2: COPIA DEL CÓDIGO DE LA APLICACIÓN
# -----------------------------------------------------

# Copia todo el código de tu proyecto al directorio de trabajo /app
# Asume que tu código está en el mismo directorio que el Dockerfile
COPY . .

# Expone el puerto que usará tu aplicación (por defecto 8000 para Uvicorn/FastAPI)
EXPOSE 8000

# RUN playwright install
# -----------------------------------------------------
# FASE 3: COMANDO DE ARRANQUE
# -----------------------------------------------------
# Comando para iniciar la aplicación. 
# Reemplaza 'app:app' con la ruta a tu aplicación si es diferente 
# (por ejemplo, 'main:app' si tu archivo es main.py)
CMD ["fastapi", "dev", "api.py", "--host", "0.0.0.0", "--port", "8000"]